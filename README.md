# 大营销系统平台设计
## 需求分析
* 奖品有随机积分、体验卡、大模型等
* 有些奖品需要抽奖满 x 次后才能解锁抽奖
* 增加运气值，每次抽奖提升运气值，到一定阶段后必中奖

## 表设计
* 策略表: 首先是需要一张策略表，不同的活动可以对应不同的策略，然后不同策略表下可以挂载不同的奖品，概率，抽奖规则等，所以我们需要一个策略表用来隔离不同活动对应的奖品和规则等
* 奖品表: 奖品表中包含如下字段：奖品id，配置，描述
* 策略_奖品表: 挂载在策略表下的奖品表。奖品表中需要有：策略id，奖品 id，标题，中奖概率，总库存，剩余库存，还有抽奖规则类型（冗余字段，完整的信息在策略_规则表中，但这里为了减少联表查询，所以添加了这个冗余字段）
* 策略_规则表: 挂载在策略下面的规则表。规则表用来实现上述的抽奖规则，比如有些奖品是需要满3次抽奖后才能解锁抽的，还有比如运气值满了后能抽到哪些奖品等。所以规则表中需要有：策略id，规则id，奖品id（不一定需要，因为规则可以作用在整个抽奖对象上，比如运气值，而不一定是单个奖品），规则作用对象（奖品、抽奖），规则类型（解锁抽奖 lock，运气抽奖 lucky，随机积分抽奖 random），规则值

## 抽奖实现
本次抽奖策略的实现是以空间换时间，实现时间复杂度为 O(1) 的抽奖策略。具体如下，假设有如下三个奖品，对应的概率如下：

| 奖品ID      | 中奖概率 |
|-----------|------|
| 奖品A(1001) | 0.7  |
| 奖品B(1002) | 0.2  |
| 奖品C(1003) | 0.1  |

我们通过一个数组来表示奖池，里面的元素都是我们的奖品 ID，奖品的中奖概率越大，那么在数组中的元素个数越多。比如根据上述的概率，我们得到如下的数组：数组元素为 10 个，其中奖品A占据了 7 个，奖品B占据了 2 个，奖品 C 占据了 1 个，这样就实现了对应的概率

```java
int[] awardIdList = {1001, 1001, 1001, 1001, 1001, 1001, 1001, 1002, 1002, 1003};
```
为了能实现 O(1) 复杂度，我们需要将上述的数组改为 Map 结构，如下：
```
const awardMap = {
  1: 1001,
  2: 1001,
  3: 1001,
  ...
}
```
最后我们将范围数据，以及上述的 Map 表都存到 redis 中，然后我们就可以进行抽奖了，如下：
```
const range = redis.getRange(strategyId);
const random = Random.get(range);

const mapTable = redis.getMapTable(strategyId)
return mapTable[random];
```

## 抽奖运气值的实现
本章节我们实现运气值功能：用户每抽一次奖会增加一点运气值，当运气值增加到一定阈值后，必中某些奖品

上述功能的实现也比较简单，核心就是对每个运气值的档位都建立一个单独的奖池即可，比如我们将运气值划分为三个档位：4000， 5000 和 6000，那么我们可以建立 3 个奖池，在根据用户当前的运气值所属的档位来判断需要使用哪个奖池即可

## 抽奖前置规则过滤
上面我们已经实现了基本的抽奖以及根据运气值进行抽奖，但实际的抽奖业务中还会涉及到白名单，黑名单等，是一个复杂的过程。所以这一章我们重构抽奖过程，添加抽奖前规则过滤流程，并为后续的抽奖中和抽奖后流程的添加奠定基础

抽奖前的规则过滤就是先判断下当前抽奖是否满足黑名单用户，如果满足则直接走黑名单抽奖，否则判断是否满足运气值抽奖，如果满足则走运气值抽奖，都不满足时则走正常流程的抽奖。流程如下，同时我们为了能支持后续添加更多的过滤功能，比如添加白名单抽奖，这里需要将抽奖规则过滤抽象出来

![img.png](docs/images/lottery-process.png)

我们定义规则过滤的标准接口，然后定义黑名单和权重规则类来实现这个接口

定义抽奖接口，并定义一个抽象实现类来固定抽奖的流程，然后再定义一个默认抽奖的子类来实现抽奖前置规则过滤功能

## 抽奖中规则过滤
上一章实现了抽奖前的过滤，本章在上一章的基础上添加抽奖中过滤。当用户抽奖奖品后，查询下当前奖品是否有解锁x次的规则，如果有，则判断是否满足，如果不满足则返回兜底奖品

![img.png](docs/images/raffle-center.png)

## 责任链方式
在前置过滤的实现中，我们现在是手动处理黑名单和权重过滤的，但这种方式并不利于代码维护，所以这一章我们使用责任链的方式重构前置过滤，如下：

![img.png](docs/images/raffle-chain.png)

**注意**: 因为每个责任链内部都包含指向下一个链的节点，因此是一个有状态节点，所以这里需要修改其创建模式，改为原型模式：
```
@Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
```
