# 大营销系统平台设计
## 需求分析
* 奖品有随机积分、体验卡、大模型等
* 有些奖品需要抽奖满 x 次后才能解锁抽奖
* 增加运气值，每次抽奖提升运气值，到一定阶段后必中奖

## 表设计
* 策略表: 首先是需要一张策略表，不同的活动可以对应不同的策略，然后不同策略表下可以挂载不同的奖品，概率，抽奖规则等，所以我们需要一个策略表用来隔离不同活动对应的奖品和规则等
* 奖品表: 奖品表中包含如下字段：奖品id，配置，描述
* 策略_奖品表: 挂载在策略表下的奖品表。奖品表中需要有：策略id，奖品 id，标题，中奖概率，总库存，剩余库存，还有抽奖规则类型（冗余字段，完整的信息在策略_规则表中，但这里为了减少联表查询，所以添加了这个冗余字段）
* 策略_规则表: 挂载在策略下面的规则表。规则表用来实现上述的抽奖规则，比如有些奖品是需要满3次抽奖后才能解锁抽的，还有比如运气值满了后能抽到哪些奖品等。所以规则表中需要有：策略id，规则id，奖品id（不一定需要，因为规则可以作用在整个抽奖对象上，比如运气值，而不一定是单个奖品），规则作用对象（奖品、抽奖），规则类型（解锁抽奖 lock，运气抽奖 lucky，随机积分抽奖 random），规则值

## 抽奖实现
本次抽奖策略的实现是以空间换时间，实现时间复杂度为 O(1) 的抽奖策略。具体如下，假设有如下三个奖品，对应的概率如下：

| 奖品ID      | 中奖概率 |
|-----------|------|
| 奖品A(1001) | 0.7  |
| 奖品B(1002) | 0.2  |
| 奖品C(1003) | 0.1  |

我们通过一个数组来表示奖池，里面的元素都是我们的奖品 ID，奖品的中奖概率越大，那么在数组中的元素个数越多。比如根据上述的概率，我们得到如下的数组：数组元素为 10 个，其中奖品A占据了 7 个，奖品B占据了 2 个，奖品 C 占据了 1 个，这样就实现了对应的概率

```java
int[] awardIdList = {1001, 1001, 1001, 1001, 1001, 1001, 1001, 1002, 1002, 1003};
```
为了能实现 O(1) 复杂度，我们需要将上述的数组改为 Map 结构，如下：
```
const awardMap = {
  1: 1001,
  2: 1001,
  3: 1001,
  ...
}
```
最后我们将范围数据，以及上述的 Map 表都存到 redis 中，然后我们就可以进行抽奖了，如下：
```
const range = redis.getRange(strategyId);
const random = Random.get(range);

const mapTable = redis.getMapTable(strategyId)
return mapTable[random];
```

## 抽奖运气值的实现
本章节我们实现运气值功能：用户每抽一次奖会增加一点运气值，当运气值增加到一定阈值后，必中某些奖品

上述功能的实现也比较简单，核心就是对每个运气值的档位都建立一个单独的奖池即可，比如我们将运气值划分为三个档位：4000， 5000 和 6000，那么我们可以建立 3 个奖池，在根据用户当前的运气值所属的档位来判断需要使用哪个奖池即可
